# -*- mode: ruby -*-
# -*- coding: utf-8 -*-

require '../config.rb'

Vagrant.require_version '>= 1.6.0'

Vagrant.configure(2) do |config|
  # Ubuntu 14.04, 64 bit
  config.vm.box         = 'ubuntu/trusty64'
  config.vm.box_version = '~> 14.04'

  # Set memory to 512
  # Allow I/O APIC
  config.vm.provider :virtualbox do |v|
    v.name = 'rethinkdb_ubuntu'
    v.customize ['modifyvm', :id, '--memory', '512', '--ioapic', 'on']
  end

  # SSH
  config.ssh.username = 'vagrant'

  # # Forward port in case of debugging
  # config.vm.network :forwarded_port, guest: 8080,  host: 8080    # For Admin app
  # config.vm.network :forwarded_port, guest: 28015, host: 28015   # For client drivers
  # config.vm.network :forwarded_port, guest: 29015, host: 29015   # For Intracluster connections

  # Static IP
  config.vm.network :private_network, ip: $rethinkdb_host_ip

  # Provisioning
  config.vm.provision :shell do |sh|
    sh.inline = <<-EOF
      export DEBIAN_FRONTEND=noninteractive;

      # Add RethinkDB Source
      apt-key adv --fetch-keys http://download.rethinkdb.com/apt/pubkey.gpg 2>&1;
      echo "deb http://download.rethinkdb.com/apt $(lsb_release -sc) main" > /etc/apt/sources.list.d/rethinkdb.list;
      apt-get update --assume-yes;

      # RethinkDB Install & Setup
      apt-get install --assume-yes rethinkdb;
      sed -e 's/# bind=127.0.0.1/bind=all/g' /etc/rethinkdb/default.conf.sample > /etc/rethinkdb/instances.d/default.conf;
      rethinkdb create -d /var/lib/rethinkdb/instances.d/default 2>&1;

      # Start rethinkdb
      service rethinkdb start;
    EOF
  end
end
